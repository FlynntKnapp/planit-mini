version: 2

jobs:
  build_and_test:
    docker:
      - image: cimg/python:3.12

    working_directory: ~/repo

    steps:
      # Step 1: Checkout code
      - checkout

      # Step 2: Install pipenv
      - run:
          name: Install pipenv
          command: |
            python -m pip install --upgrade pip
            pip install pipenv

      # Step 3: Install dependencies
      - run:
          name: Install dependencies with pipenv
          command: |
            pipenv install --dev

      # Step 4: Run linter (flake8)
      - run:
          name: Run flake8 linter
          command: |
            pipenv run flake8 .

      # Step 5: Run pytest with coverage (accounts-focused for now)
      - run:
          name: Run pytest with coverage for accounts app
          command: |
            pipenv run pytest \
              --cov=accounts \
              --cov-report=term-missing \
              --cov-fail-under=80

workflows:
  version: 2
  test_pipeline:
    jobs:
      - build_and_test
