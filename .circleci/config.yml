# CircleCI config for planit-mini (tests only)
version: 2

jobs:
  build_and_test:
    docker:
      - image: cimg/python:3.11.5

    working_directory: ~/repo

    steps:
      # Step 1: Checkout code
      - checkout

      # Step 2: Install pipenv (if not already on the image)
      - run:
          name: Install pipenv
          command: |
            python -m pip install --upgrade pip
            pip install pipenv

      # Step 3: Install dependencies
      - run:
          name: Install dependencies with pipenv
          command: |
            pipenv install --dev

      # Step 4 (optional): Run linter
      # You can comment this out if you don't have flake8 wired up yet
      - run:
          name: Run flake8 linter
          command: |
            pipenv run flake8 || echo "flake8 failed (or not configured) - adjust as needed"

      # Step 5: Run tests with coverage
      - run:
          name: Run Django tests with coverage
          command: |
            pipenv run coverage run \
              --source='.' \
              --omit="*/asgi.py,*/wsgi.py,*/manage.py,*/config/settings/*" \
              ./manage.py test
            pipenv run coverage report

workflows:
  version: 2
  test_pipeline:
    jobs:
      - build_and_test
