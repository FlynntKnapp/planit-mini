version: 2.1

jobs:
  build_and_test:
    docker:
      - image: cimg/python:3.12

    working_directory: ~/repo

    steps:
      # Step 1: Checkout code
      - checkout

      # Step 2: Install pipenv
      - run:
          name: Install pipenv
          command: |
            python -m pip install --upgrade pip
            pip install pipenv

      # Step 3: Install dependencies
      - run:
          name: Install dependencies with pipenv
          command: |
            pipenv install --dev

      # Step 4: Run linter (flake8)
      - run:
          name: Run flake8 linter
          command: |
            pipenv run flake8 .

      # Step 5: Run pytest with coverage
      - run:
          name: Run pytest with coverage
          command: |
            pipenv run pytest \
              --cov=accounts \
              --cov=assets \
              --cov=core \
              --cov=work \
              --cov-report=term-missing \
              --cov-fail-under=80

  deploy:
    docker:
      - image: cimg/python:3.12

    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Deploy main to Heroku
          command: |
            # HEROKU_APP_NAME and HEROKU_API_KEY are set in CircleCI project settings.
            git push https://heroku:${HEROKU_API_KEY}@git.heroku.com/${HEROKU_APP_NAME}.git main

workflows:
  version: 2
  test_and_deploy:
    jobs:
      - build_and_test
      - deploy:
          requires:
            - build_and_test
          filters:
            branches:
              only: main
