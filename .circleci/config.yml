version: 2

jobs:
  build_and_test:
    docker:
      - image: cimg/python:3.12

    working_directory: ~/repo

    steps:
      # Step 1: Checkout code
      - checkout

      # Step 2: Install pipenv
      - run:
          name: Install pipenv
          command: |
            python -m pip install --upgrade pip
            pip install pipenv

      # Step 3: Install dependencies
      - run:
          name: Install dependencies with pipenv
          command: |
            pipenv install --dev

      # Step 4: Run linter (flake8)
      - run:
          name: Run flake8 linter
          command: |
            pipenv run flake8 .

      # Step 5: Run tests (accounts only) with coverage
      - run:
          name: Run Django tests for accounts app with coverage
          command: |
            pipenv run coverage run \
              --source='accounts' \
              --omit="*/asgi.py,*/wsgi.py,*/manage.py,*/config/settings/*" \
              ./manage.py test accounts
            pipenv run coverage report

workflows:
  version: 2
  test_pipeline:
    jobs:
      - build_and_test
